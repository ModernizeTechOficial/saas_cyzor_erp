name: Deploy Laravel - ModernizeTech

on:
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomínio para deploy (ex: denovoagora.cyzor.com.br)'
        required: true
        type: string
      db_host:
        description: 'Database host'
        required: true
        default: 'localhost'
        type: string
      db_database:
        description: 'Nome do banco de dados'
        required: true
        type: string
      db_username:
        description: 'Usuário do banco'
        required: true
        type: string
      db_password:
        description: 'Senha do banco'
        required: true
        type: string
      repository_url:
        description: 'URL SSH do repositório GitHub'
        required: true
        default: 'git@github.com:ModernizeTechOficial/saas_cyzor_erp.git'
        type: string
      sql_file_path:
        description: 'Caminho do dump SQL dentro do repositório'
        required: false
        default: 'database/dump.sql'
        type: string
      purchase_id:
        description: 'ID da compra (opcional)'
        required: false
        default: 'vazio'
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY_RSA }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Debug - Mostrar inputs recebidos
        run: |
          echo "===== DEBUG: Inputs recebidos ====="
          echo "Subdomínio: ${{ inputs.subdomain }}"
          echo "DB Host: ${{ inputs.db_host }}"
          echo "DB Name: ${{ inputs.db_database }}"
          echo "DB User: ${{ inputs.db_username }}"
          echo "DB Password: [OCULTO]"
          echo "Repo URL: ${{ inputs.repository_url }}"
          echo "SQL Path: ${{ inputs.sql_file_path }}"
          echo "=================================="

      - name: Deploy no Servidor (Corrigido)
        run: |
          export TERM=xterm
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << EOF
            set -e
            export TERM=xterm

            # Variáveis interpoladas localmente (no runner) e enviadas ao servidor
            SUBDOMAIN="${{ inputs.subdomain }}"
            DB_HOST="${{ inputs.db_host }}"
            DB_DATABASE="${{ inputs.db_database }}"
            DB_USERNAME="${{ inputs.db_username }}"
            DB_PASSWORD="${{ inputs.db_password }}"
            REPO_URL="${{ inputs.repository_url }}"
            SQL_PATH="${{ inputs.sql_file_path }}"

            echo "Iniciando deploy para: https://\$SUBDOMAIN"

            TARGET_DIR="/home/\$SUBDOMAIN/public_html"
            mkdir -p "\$TARGET_DIR"
            cd "\$TARGET_DIR"

            # Backup automático se já existir algo
            if [ -d "\$TARGET_DIR" ] && [ "\$(ls -A "\$TARGET_DIR" 2>/dev/null || echo '')" ]; then
              echo "Criando backup..."
              BACKUP_FILE="../backup_\$(date +%F_%H-%M-%S).tar.gz"
              tar -czf "\$BACKUP_FILE" ./* 2>/dev/null || echo "Backup falhou ou diretório vazio"
              rm -rf ./*
            fi

            # Clone do repositório privado
            echo "Clonando repositório..."
            git clone "\$REPO_URL" . || { echo "Erro no git clone"; exit 1; }

            # Verificar se .env.example existe
            if [ ! -f .env.example ]; then
              echo "Erro: .env.example não encontrado!"
              exit 1
            fi

            # Configuração do .env
            cp .env.example .env
            sed -i "s|APP_URL=.*|APP_URL=https://\$SUBDOMAIN|" .env
            sed -i "s|DB_HOST=.*|DB_HOST=\$DB_HOST|" .env
            sed -i "s|DB_DATABASE=.*|DB_DATABASE=\$DB_DATABASE|" .env
            sed -i "s|DB_USERNAME=.*|DB_USERNAME=\$DB_USERNAME|" .env
            sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=\$DB_PASSWORD|" .env

            # Aplicar template do Virtual Host (LiteSpeed)
            TEMPLATE_PATH="\$TARGET_DIR/.github/templates/vhconf.template"
            VHOST_DIR="/usr/local/lsws/conf/vhosts/\$SUBDOMAIN"

            if [ -f "\$TEMPLATE_PATH" ]; then
              echo "Aplicando configuração do Virtual Host..."
              sudo mkdir -p "\$VHOST_DIR"
              sudo cp "\$TEMPLATE_PATH" "\$VHOST_DIR/vhconf.conf"
              sudo sed -i "s|{{DOMAIN}}|\$SUBDOMAIN|g" "\$VHOST_DIR/vhconf.conf"
              sudo sed -i "s|{{PUBLIC_DIR}}|\$TARGET_DIR/public|g" "\$VHOST_DIR/vhconf.conf"
              sudo /usr/local/lsws/bin/lswsctrl reload || echo "Falha no reload do LiteSpeed"
              echo "Virtual Host configurado e recarregado"
            else
              echo "Template de vhost não encontrado em \$TEMPLATE_PATH"
            fi

            # Corrigir permissões
            USUARIO=\$(stat -c '%U' ..)
            sudo chown -R "\$USUARIO:\$USUARIO" .
            sudo find . -type d -exec chmod 755 {} \;
            sudo find . -type f -exec chmod 644 {} \;
            sudo chmod -R 775 storage bootstrap/cache 2>/dev/null || true

            # Instalar dependências
            echo "Instalando Composer..."
            composer install --no-interaction --optimize-autoloader --no-dev

            if [ -f package.json ]; then
              echo "Instalando Node.js dependencies..."
              npm ci --only=production || npm install --production
            fi

            # Laravel
            php artisan key:generate --force
            php artisan storage:link
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Importar dump SQL (se existir)
            SQL_FILE="\$TARGET_DIR/\$SQL_PATH"
            if [ -f "\$SQL_FILE" ]; then
              echo "Importando banco de dados: \$SQL_FILE"
              mysql -h "\$DB_HOST" -u "\$DB_USERNAME" -p"\$DB_PASSWORD" "\$DB_DATABASE" < "\$SQL_FILE"
              echo "Banco de dados importado com sucesso"
            else
              echo "Arquivo SQL não encontrado: \$SQL_FILE (pular importação)"
            fi

            # Limpar cache do Laravel e LiteSpeed
            rm -rf storage/framework/cache/data/* 2>/dev/null || true
            sudo /usr/local/lsws/bin/lswsctrl reload || true

            echo "DEPLOY CONCLUÍDO COM SUCESSO!"
            echo "Acesse: https://\$SUBDOMAIN"
          EOF
