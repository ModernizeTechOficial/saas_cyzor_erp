name: Deploy Laravel - ModernizeTech
on:
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomínio para deploy (ex: cliente1.modernizetech.com.br)'
        required: true
      db_host:
        description: 'Database host'
        required: true
        default: 'localhost'
      db_database:
        description: 'Database name'
        required: true
      db_username:
        description: 'Database username'
        required: true
      db_password:
        description: 'Database password'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do workflow
        uses: actions/checkout@v4

      - name: Configurar chave SSH para o servidor
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY_RSA }}" > ~/.ssh/deploy_modernize_rsa
          chmod 600 ~/.ssh/deploy_modernize_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy no servidor (saas_cyzor_erp)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}   # Tem acesso total ao seu repo
        run: |
          ssh -i ~/.ssh/deploy_modernize_rsa -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e

            TARGET_DIR="/home/${{ github.event.inputs.subdomain }}/public_html"
            PUBLIC_DIR="$TARGET_DIR/public"

            echo "Preparando $TARGET_DIR"
            mkdir -p "$TARGET_DIR"
            cd "$TARGET_DIR"

            # Backup do deploy antigo
            if [ -n "$(ls -A . 2>/dev/null)" ]; then
              echo "Backup do deploy anterior..."
              tar -czf "../backup_$(date +%F_%H-%M-%S).tar.gz" ./* 2>/dev/null || true
              rm -rf ./*
            fi

            # CLONE DO REPOSITÓRIO CORRETO COM TOKEN
            echo "Clonando saas_cyzor_erp..."
            git clone https://$GITHUB_TOKEN@github.com/ModernizeTechOficial/saas_cyzor_erp.git .

            # Configuração .env
            cp .env.example .env
            sed -i "s|APP_URL=.*|APP_URL=https://${{ github.event.inputs.subdomain }}|g" .env
            sed -i "s|DB_HOST=.*|DB_HOST=${{ github.event.inputs.db_host }}|" .env
            sed -i "s|DB_DATABASE=.*|DB_DATABASE=${{ github.event.inputs.db_database }}|" .env
            sed -i "s|DB_USERNAME=.*|DB_USERNAME=${{ github.event.inputs.db_username }}|" .env
            sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=${{ github.event.inputs.db_password }}|" .env

            # Vhost OpenLiteSpeed/LiteSpeed
            TEMPLATE_PATH="$TARGET_DIR/.github/templates/vhconf.template"
            VHOST_DIR="/usr/local/lsws/conf/vhosts/${{ github.event.inputs.subdomain }}"
            if [ -f "$TEMPLATE_PATH" ]; then
              sudo mkdir -p "$VHOST_DIR"
              sudo cp "$TEMPLATE_PATH" "$VHOST_DIR/vhconf.conf"
              sudo sed -i "s|{{DOMAIN}}|${{ github.event.inputs.subdomain }}|g" "$VHOST_DIR/vhconf.conf"
              sudo sed -i "s|{{PUBLIC_DIR}}|$PUBLIC_DIR|g" "$VHOST_DIR/vhconf.conf"
              sudo /usr/local/lsws/bin/lswsctrl reload
              echo "Vhost aplicado"
            else
              echo "Template não encontrado (normal no primeiro deploy)"
            fi

            # Permissões corretas
            USUARIO=$(stat -c '%U' ..)
            sudo chown -R "$USUARIO:$USUARIO" .
            sudo find . -type d -exec chmod 755 {} \;
            sudo find . -type f -exec chmod 644 {} \;
            sudo chmod -R 775 storage bootstrap/cache 2>/dev/null || true

            # Instalação Laravel
            composer install --no-interaction --no-dev --optimize-autoloader
            [ -f package.json ] && npm ci && npm run production || echo "Sem frontend assets"

            php artisan key:generate --force
            php artisan migrate --force
            php artisan db:seed --force || echo "Sem seeders"
            php artisan storage:link || true
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            echo "Deploy do saas_cyzor_erp concluído com sucesso!"
            echo "https://${{ github.event.inputs.subdomain }}"
          EOF
