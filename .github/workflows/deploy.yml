name: Deploy Laravel - ModernizeTech

on:
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomain for deployment'
        required: true
      db_host:
        description: 'Database host'
        required: true
        default: 'localhost'
      db_database:
        description: 'Database name'
        required: true
      db_username:
        description: 'Database username'
        required: true
      db_password:
        description: 'Database password'
        required: true
      repository_url:
        description: 'Repository SSH URL'
        required: true
        default: 'git@github.com:ModernizeTechOficial/saas_cyzor_erp.git'
      sql_file_path:
        description: 'Caminho do SQL dump dentro do repositório'
        required: false
        default: 'database/dump.sql'
      purchase_id:
        description: 'ID da compra'
        required: false
        default: 'não encontrado'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PURCHASE_ID: ${{ github.event.inputs.purchase_id }}
      SUBDOMAIN: ${{ github.event.inputs.subdomain }}

    steps:
      - name: Checkout workflow
        uses: actions/checkout@v4

      - name: Notificar API sobre deploy (antes de tudo)
        env:
          PURCHASE_ID: ${{ github.event.inputs.purchase_id }}
          SUBDOMAIN: ${{ github.event.inputs.subdomain }}
        run: |
          echo "Enviando purchase_id para a API antes do deploy..."
          curl -X POST "https://cyzor.com.br/api/github/webhook" \
            -H "Content-Type: application/json" \
            -d "{\"purchase_id\": \"${PURCHASE_ID}\", \"subdomain\": \"${SUBDOMAIN}\"}"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY_RSA }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          echo "===== DEBUG: Inputs recebidos ====="
          echo "Subdomain: ${{ github.event.inputs.subdomain }}"
          echo "DB Host: ${{ github.event.inputs.db_host }}"
          echo "DB Name: ${{ github.event.inputs.db_database }}"
          echo "DB User: ${{ github.event.inputs.db_username }}"
          echo "DB Password: ${{ github.event.inputs.db_password }}"
          echo "Repository URL: ${{ github.event.inputs.repository_url }}"
          echo "SQL File Path: ${{ github.event.inputs.sql_file_path }}"
          echo "Purchase ID: ${{ github.event.inputs.purchase_id }}"
          echo "=================================="

      - name: Deploy Real
        run: |
          export TERM=xterm
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            export TERM=xterm
            TARGET_DIR=/home/${{ github.event.inputs.subdomain }}/public_html

            # Função que marca as etapas no log do GitHub Actions
            notify() {
              echo "::set-output name=step::$1"
              echo "::set-output name=status::$2"
            }

            notify "Iniciando deploy no servidor" "in_progress"

            mkdir -p "$TARGET_DIR"
            cd "$TARGET_DIR"

            # Backup se existir conteúdo
            if [ -d "$TARGET_DIR" ] && [ "$(ls -A "$TARGET_DIR")" ]; then
              echo "Criando backup..."
              tar -czf "../backup_$(date +%F_%H-%M-%S).tar.gz" ./* || echo "Backup falhou"
              rm -rf ./*
            fi
            notify "Backup concluído" "completed"

            # Clonar repositório privado usando a chave criada
            export GIT_SSH_COMMAND='ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no'
            git clone "${{ github.event.inputs.repository_url }}" .
            notify "Repositório clonado" "completed"

            if [ ! -f .env.example ]; then
              echo "Erro: .env.example não encontrado!"
              exit 1
            fi

            # Configurar .env
            cp .env.example .env
            sed -i "s|APP_URL=.*|APP_URL=https://${{ github.event.inputs.subdomain }}|" .env
            sed -i "s|DB_HOST=.*|DB_HOST=${{ github.event.inputs.db_host }}|" .env
            sed -i "s|DB_DATABASE=.*|DB_DATABASE=${{ github.event.inputs.db_database }}|" .env
            sed -i "s|DB_USERNAME=.*|DB_USERNAME=${{ github.event.inputs.db_username }}|" .env
            sed -i "s|DB_PASSWORD=.*|DB_PASSWORD=${{ github.event.inputs.db_password }}|" .env
            notify ".env configurado" "completed"

            # Aplicar template do vhost
            TEMPLATE_PATH="$TARGET_DIR/.github/templates/vhconf.template"
            VHOST_DIR="/usr/local/lsws/conf/vhosts/${{ github.event.inputs.subdomain }}"
            if [ -f "$TEMPLATE_PATH" ]; then
                echo "Aplicando template do vhost..."
                sudo mkdir -p "$VHOST_DIR"
                sudo cp "$TEMPLATE_PATH" "$VHOST_DIR/vhconf.conf"
                sudo sed -i "s|{{DOMAIN}}|${{ github.event.inputs.subdomain }}|g" "$VHOST_DIR/vhconf.conf"
                sudo sed -i "s|{{PUBLIC_DIR}}|$TARGET_DIR/public|g" "$VHOST_DIR/vhconf.conf"
                sudo /usr/local/lsws/bin/lswsctrl reload
                echo "Template do vhost aplicado"
            else
                echo "Template do vhost não encontrado em $TEMPLATE_PATH"
            fi
            notify "Virtual Host configurado" "completed"

            # Permissões
            USUARIO=$(stat -c '%U' ..)
            sudo chown -R "$USUARIO:$USUARIO" .
            sudo find . -type d -exec chmod 755 {} \;
            sudo find . -type f -exec chmod 644 {} \;
            sudo chmod -R 775 storage bootstrap/cache || true
            notify "Permissões ajustadas" "completed"

            # Instalação de dependências
            composer install --no-interaction --optimize-autoloader
            if [ -f package.json ]; then
              npm ci || true
            fi
            notify "Dependências instaladas" "completed"

            # Configurações Laravel
            php artisan key:generate --force
            php artisan storage:link
            notify "Laravel configurado" "completed"

            # Importar dump SQL do repositório
            SQL_FILE="$TARGET_DIR/${{ github.event.inputs.sql_file_path }}"
            if [ -f "$SQL_FILE" ]; then
              echo "Importando dump SQL $SQL_FILE..."
              mysql -h "${{ github.event.inputs.db_host }}" \
                    -u "${{ github.event.inputs.db_username }}" \
                    -p"${{ github.event.inputs.db_password }}" \
                    "${{ github.event.inputs.db_database }}" < "$SQL_FILE"
              echo "Dump SQL importado com sucesso"
              notify "Banco de dados importado" "completed"
            else
              echo "Arquivo SQL não encontrado: $SQL_FILE"
              notify "Banco de dados (sem dump)" "completed"
            fi

            rm -rf "$TARGET_DIR/cache/*" || true
            sudo /usr/local/lsws/bin/lswsctrl reload
            echo "Deploy concluído com sucesso!"
            notify "Deploy concluído com sucesso!" "completed"
          EOF

      # AQUI É ONDE A MÁGICA ACONTECE: envia TODAS as etapas pro seu painel
      - name: Enviar etapas para o painel
        if: always()
        run: |
          # Pega todas as linhas que o notify() gravou no log
          grep "step::" -A1 "${{ github.event_path }}" || true > /tmp/steps.txt

          while IFS= read -r step_line && IFS= read -r status_line <&3; do
            STEP=$(echo "$step_line" | cut -d: -f3-)
            STATUS=$(echo "$status_line" | cut -d: -f3-)
            
            curl -X POST https://cyzor.com.br/api/github/deploy-step \
              -H "Content-Type: application/json" \
              -d "{
                \"purchase_id\": \"${{ env.PURCHASE_ID }}\",
                \"subdomain\": \"${{ env.SUBDOMAIN }}\",
                \"step\": \"$STEP\",
                \"status\": \"$STATUS\"
              }" || true
          done < /tmp/steps.txt 3< /tmp/steps.txt

      # Final (opcional)
      - name: Notificar sucesso final
        if: success()
        run: |
          curl -X POST https://cyzor.com.br/api/github/deploy-step \
            -H "Content-Type: application/json" \
            -d '{
              "purchase_id": "${{ env.PURCHASE_ID }}",
              "subdomain": "${{ env.SUBDOMAIN }}",
              "step": "Site no ar!",
              "status": "completed"
            }'
