name: Deploy Laravel - ModernizeTech

on:
  workflow_dispatch:
    inputs:
      subdomain:
        description: 'Subdomain for deployment'
        required: true
      db_host:
        description: 'Database host'
        required: true
        default: 'localhost'
      db_database:
        description: 'Database name'
        required: true
      db_username:
        description: 'Database username'
        required: true
      db_password:
        description: 'Database password'
        required: true
      repository_url:
        description: 'Repository SSH URL'
        required: true
        default: 'git@github.com:ModernizeTechOficial/saas_cyzor_erp.git'
      sql_file_path:
        description: 'Caminho do SQL dump dentro do repositório'
        required: false
        default: 'database/dump.sql'
      purchase_id:
        description: 'ID da compra'
        required: false
        default: 'não encontrado'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout workflow
        uses: actions/checkout@v4

      - name: Notificar API antes do deploy
        env:
          PURCHASE_ID: ${{ github.event.inputs.purchase_id }}
          SUBDOMAIN: ${{ github.event.inputs.subdomain }}
        run: |
          echo "✅ Enviando purchase_id para a API antes do deploy..."
          curl -X POST "https://cyzor.com.br/api/github/webhook" \
            -H "Content-Type: application/json" \
            -d "{\"purchase_id\": \"${PURCHASE_ID}\", \"subdomain\": \"${SUBDOMAIN}\"}"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY_RSA }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy Real
        env:
          PURCHASE_ID: ${{ github.event.inputs.purchase_id }}
          SUBDOMAIN: ${{ github.event.inputs.subdomain }}
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} bash -c "
            set -e
            export TERM=xterm
            TARGET_DIR=/home/${SUBDOMAIN}/public_html
            mkdir -p \$TARGET_DIR
            cd \$TARGET_DIR

            # Notificação início
            curl -X POST 'https://cyzor.com.br/api/github/deploy-step' \
              -H 'Content-Type: application/json' \
              -d '{\"purchase_id\": \"${PURCHASE_ID}\", \"subdomain\": \"${SUBDOMAIN}\", \"step\": \"Deploy iniciado\", \"status\": \"start\"}'

            # Backup
            if [ -d \$TARGET_DIR ] && [ \"\$(ls -A \$TARGET_DIR)\" ]; then
              tar -czf \"../backup_\$(date +%F_%H-%M-%S).tar.gz\" ./* || true
              rm -rf ./*
            fi

            # Clonar repositório
            git clone '${{ github.event.inputs.repository_url }}' .

            # Configurar .env
            cp .env.example .env
            sed -i 's|APP_URL=.*|APP_URL=https://${SUBDOMAIN}|' .env
            sed -i 's|DB_HOST=.*|DB_HOST=${{ github.event.inputs.db_host }}|' .env
            sed -i 's|DB_DATABASE=.*|DB_DATABASE=${{ github.event.inputs.db_database }}|' .env
            sed -i 's|DB_USERNAME=.*|DB_USERNAME=${{ github.event.inputs.db_username }}|' .env
            sed -i 's|DB_PASSWORD=.*|DB_PASSWORD=${{ github.event.inputs.db_password }}|' .env

            # Deploy finalizado
            curl -X POST 'https://cyzor.com.br/api/github/deploy-step' \
              -H 'Content-Type: application/json' \
              -d '{\"purchase_id\": \"${PURCHASE_ID}\", \"subdomain\": \"${SUBDOMAIN}\", \"step\": \"Deploy finalizado\", \"status\": \"finish\"}'
          "
